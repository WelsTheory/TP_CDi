%% Control Digital en Sistemas Embebidos - MSE - PRACTICA 2

clc
clear all
close all
%%
% 1) Crear una función en Matlab que aplique la función de identificación por 
% método de cuadrados mínimos (LS) y obtenga el vector de parámetros del modelo 
% a partir del orden deseado del sistema y las señales de entrada/salida.
%%

R1 = 2e3;
C1 = 1e-6;
R2 = 1e3;
C2 = 1e-6;
%% 
% Opcion 1: Realizar el desarrollo matematico de la ecuación diferencial 
% del circuito y obtener la función transferencia en el dominio de Laplace
% Hs = 1 / ((R1*C1*R2*C2)*s^2 + (R1*C1+R1*C2+R2*C2)*s + 1)
s = tf('s');
Hs = 1 / ((R1*C1*R2*C2)*s^2 + (R1*C1+R1*C2+R2*C2)*s + 1)
[num den] = tfdata(Hs, 'v');


%%
% 3) Discretizar la planta con un período de muestreo h = 0.1s.
%%

h = 0.1;

Hz = c2d(Hs, h, 'zoh')

%%
% 4) Identificar los parámetros de la planta para orden 2 y 3 utilizando la 
% función LS creada anteriormente.
%%

t = 1:h:40;

[numz, denz] = tfdata(Hz, 'v');

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.148,1.19,1.299,1.258,1.316,1.641,1.438,1.596,1.293,1.7,1.316,1.906,2.096,2.058,1.254,1.861,1.254,1.474,1.932,1.648,1.864,1.361,1.919,1.164,1.396,1.225,1.606,1.983,1.851,1.441,1.68,2.032,1.938,1.645,1.212,2.109,1.954,2.016,1.864,1.229,1.18,2.116,1.438,1.851,1.419,1.387,1.722,1.77,1.461,2.145,1.551,1.432,1.674,1.158,1.645,1.916,1.738,1.706,1.874,1.938,2.054,1.945,1.47,1.87,1.509,1.312,1.312,1.161,1.212,2.099,2.022,1.567,1.88,1.883,1.509,2.064,1.412,1.809,1.229,1.696,1.916,1.829,1.19,1.932,2.141,2.116,1.658,1.835,1.319,1.17,1.803,2.119,1.69,1.958,1.422,1.761,1.458,1.835,1.2,1.458,1.251,1.274,1.722,1.732,1.616,1.864,1.383,1.59,1.845,1.212,1.732,2.022,1.783,2.038,1.703,2.048,1.364,1.312,1.303,1.296,1.638,1.67,1.761,1.361,1.88,1.48,1.693,1.306,2.074,1.9,1.483,1.538,1.732,1.645,1.916,1.193,1.964,1.187,1.174,1.745,1.583,1.78,1.758,1.632,1.203,1.619,1.887,1.299,1.206,1.887,2.074,1.548,1.312,2.103,1.851,1.361,1.864,1.78,2.009,1.235,1.703,1.98,1.945,1.841,1.174,1.983,1.645,1.59,1.793,1.522,1.799,1.425,1.803,1.187,1.706,2.116,1.593,2.054,1.296,1.803,2.025,1.287,1.532,1.332,1.387,1.474,1.187,1.374,1.529,2.038,1.49,1.677,1.696,1.28,1.845,1.596,1.203,1.193,2.022,1.477,1.49,1.151,1.49,1.606,2.0,1.258,1.929,1.625,1.787,1.477,1.203,1.612,1.883,1.835,1.712,1.454,1.28,1.722,1.722,2.0,1.377,1.712,1.945,2.009,1.193,2.119,1.435,1.761,1.996,1.209,2.061,1.348,1.625,1.519,2.019,1.57,1.58,1.216,1.864,1.59,1.232,1.529,1.712,2.148,1.654,1.299,1.493,1.222,2.122,1.38,1.87,1.519,1.977,1.167,1.538,1.464,1.996,1.39,1.948,1.938,1.39,1.632,1.148,1.516,1.806,1.39,2.112,1.38,1.387,1.98,1.487,1.593,1.58,1.148,1.47,1.39,1.974,1.983,2.122,1.661,1.158,1.693,1.493,1.635,1.19,1.78,2.061,2.0,1.683,1.429,1.832,2.141,1.625,1.774,1.635,1.27,1.741,1.829,1.696,1.403,1.18,1.954,2.058,1.858,1.658,1.245,1.229,2.016,2.045,1.674,1.916,1.703,2.103,2.09,1.719,1.496,1.425,1.341,1.612,1.287,1.545,1.399,1.241,1.506,1.864,1.961,1.267,1.7,1.325,1.99,2.09,1.741,1.619,1.309,1.287,1.232,2.035,1.916,2.099,1.522,2.141,2.103,1.741,1.751,1.329,2.074,1.851,1.19,1.777,2.106,1.558,1.861,1.89,2.077,2.058,1.503,1.193,1.9,1.616,1.816,1.174,1.89,1.851,1.683,1.938,1.941,1.261,1.322,1.258,1.845,1.993,1.441,1.512,1.474,1.793,1.338,1.874,1.732,1.183,1.641,1.525,2.08,2.083,1.987,1.448,1.596,1.467,1.97,2.019,1.322,1.322];

y = [1.351,1.212,1.219,1.264,1.27,1.387,1.512,1.5,1.487,1.451,1.529,1.525,1.835,2.016,1.838,1.574,1.616,1.416,1.57,1.754,1.735,1.693,1.6,1.629,1.354,1.335,1.351,1.629,1.848,1.745,1.587,1.741,1.925,1.858,1.59,1.548,1.906,1.958,1.958,1.725,1.358,1.467,1.758,1.635,1.674,1.48,1.496,1.667,1.661,1.693,1.861,1.609,1.538,1.5,1.37,1.638,1.79,1.745,1.758,1.858,1.945,1.99,1.835,1.67,1.725,1.516,1.358,1.287,1.2,1.438,1.89,1.867,1.732,1.835,1.774,1.725,1.796,1.622,1.603,1.451,1.68,1.822,1.661,1.512,1.864,2.058,1.983,1.793,1.687,1.383,1.39,1.764,1.909,1.822,1.777,1.609,1.638,1.603,1.603,1.38,1.38,1.29,1.39,1.629,1.67,1.696,1.69,1.519,1.635,1.619,1.458,1.725,1.877,1.877,1.903,1.848,1.812,1.477,1.351,1.312,1.387,1.577,1.664,1.629,1.57,1.687,1.593,1.554,1.577,1.887,1.79,1.58,1.596,1.667,1.719,1.67,1.525,1.635,1.309,1.354,1.59,1.635,1.732,1.716,1.545,1.403,1.622,1.658,1.377,1.425,1.803,1.864,1.577,1.59,1.89,1.738,1.593,1.764,1.832,1.758,1.503,1.712,1.896,1.903,1.683,1.529,1.761,1.664,1.661,1.683,1.635,1.654,1.587,1.574,1.429,1.729,1.87,1.793,1.783,1.561,1.79,1.77,1.487,1.461,1.38,1.403,1.377,1.287,1.383,1.619,1.777,1.619,1.664,1.577,1.506,1.68,1.519,1.28,1.432,1.709,1.548,1.416,1.309,1.464,1.667,1.712,1.558,1.741,1.7,1.68,1.464,1.377,1.612,1.793,1.787,1.664,1.464,1.441,1.641,1.77,1.774,1.574,1.732,1.9,1.767,1.593,1.79,1.622,1.777,1.732,1.58,1.735,1.529,1.567,1.661,1.803,1.638,1.503,1.461,1.68,1.522,1.387,1.532,1.774,1.912,1.635,1.441,1.406,1.503,1.754,1.616,1.683,1.69,1.683,1.409,1.477,1.606,1.725,1.629,1.851,1.774,1.561,1.483,1.335,1.535,1.622,1.641,1.787,1.496,1.558,1.735,1.583,1.583,1.467,1.322,1.403,1.541,1.854,1.983,1.964,1.616,1.419,1.561,1.548,1.493,1.425,1.748,1.958,1.906,1.68,1.603,1.841,1.925,1.748,1.729,1.567,1.47,1.683,1.751,1.635,1.409,1.441,1.835,1.945,1.829,1.6,1.338,1.458,1.838,1.9,1.799,1.825,1.838,2.022,1.974,1.735,1.545,1.435,1.435,1.47,1.406,1.461,1.377,1.345,1.548,1.799,1.735,1.512,1.545,1.558,1.89,1.945,1.767,1.577,1.377,1.296,1.454,1.838,1.941,1.906,1.79,2.029,1.99,1.812,1.654,1.612,1.88,1.69,1.48,1.774,1.87,1.732,1.829,1.919,2.025,1.906,1.535,1.467,1.7,1.693,1.616,1.48,1.758,1.783,1.777,1.893,1.751,1.412,1.325,1.422,1.761,1.787,1.561,1.509,1.564,1.609,1.551,1.741,1.593,1.416,1.545,1.674,1.961,2.025,1.858,1.6,1.558,1.622,1.883,1.803,1.803];


[Theta_LS_1] = identificacionLS(1, u, y);
numz_LS_1 = [Theta_LS_1(2) Theta_LS_1(3)];
denz_LS_1 = [1 -Theta_LS_1(1)];

[Theta_LS_2] = identificacionLS(2, u, y);
numz_LS_2 = [Theta_LS_2(3) Theta_LS_2(4) Theta_LS_2(5)];
denz_LS_2 = [1 -Theta_LS_2(1) -Theta_LS_2(2)];

%%
% 5)Obtener el error de ambas identificaciones utilizando la función de costo J.
%%

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
J_1 = (y-y_LS_1)'*(y-y_LS_1)/2;

y_LS_2 = filter(numz_LS_2, denz_LS_2, u);
J_2 = (y-y_LS_2)'*(y-y_LS_2)/2;

%%
% 6)Comparar la respuesta de los modelos obtenidos en el punto 4 con la 
% respuesta de la planta real utilizando la misma señal de entrada.
%%

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.148,1.19,1.299,1.258,1.316,1.641,1.438,1.596,1.293,1.7,1.316,1.906,2.096,2.058,1.254,1.861,1.254,1.474,1.932,1.648,1.864,1.361,1.919,1.164,1.396,1.225,1.606,1.983,1.851,1.441,1.68,2.032,1.938,1.645,1.212,2.109,1.954,2.016,1.864,1.229,1.18,2.116,1.438,1.851,1.419,1.387,1.722,1.77,1.461,2.145,1.551,1.432,1.674,1.158,1.645,1.916,1.738,1.706,1.874,1.938,2.054,1.945,1.47,1.87,1.509,1.312,1.312,1.161,1.212,2.099,2.022,1.567,1.88,1.883,1.509,2.064,1.412,1.809,1.229,1.696,1.916,1.829,1.19,1.932,2.141,2.116,1.658,1.835,1.319,1.17,1.803,2.119,1.69,1.958,1.422,1.761,1.458,1.835,1.2,1.458,1.251,1.274,1.722,1.732,1.616,1.864,1.383,1.59,1.845,1.212,1.732,2.022,1.783,2.038,1.703,2.048,1.364,1.312,1.303,1.296,1.638,1.67,1.761,1.361,1.88,1.48,1.693,1.306,2.074,1.9,1.483,1.538,1.732,1.645,1.916,1.193,1.964,1.187,1.174,1.745,1.583,1.78,1.758,1.632,1.203,1.619,1.887,1.299,1.206,1.887,2.074,1.548,1.312,2.103,1.851,1.361,1.864,1.78,2.009,1.235,1.703,1.98,1.945,1.841,1.174,1.983,1.645,1.59,1.793,1.522,1.799,1.425,1.803,1.187,1.706,2.116,1.593,2.054,1.296,1.803,2.025,1.287,1.532,1.332,1.387,1.474,1.187,1.374,1.529,2.038,1.49,1.677,1.696,1.28,1.845,1.596,1.203,1.193,2.022,1.477,1.49,1.151,1.49,1.606,2.0,1.258,1.929,1.625,1.787,1.477,1.203,1.612,1.883,1.835,1.712,1.454,1.28,1.722,1.722,2.0,1.377,1.712,1.945,2.009,1.193,2.119,1.435,1.761,1.996,1.209,2.061,1.348,1.625,1.519,2.019,1.57,1.58,1.216,1.864,1.59,1.232,1.529,1.712,2.148,1.654,1.299,1.493,1.222,2.122,1.38,1.87,1.519,1.977,1.167,1.538,1.464,1.996,1.39,1.948,1.938,1.39,1.632,1.148,1.516,1.806,1.39,2.112,1.38,1.387,1.98,1.487,1.593,1.58,1.148,1.47,1.39,1.974,1.983,2.122,1.661,1.158,1.693,1.493,1.635,1.19,1.78,2.061,2.0,1.683,1.429,1.832,2.141,1.625,1.774,1.635,1.27,1.741,1.829,1.696,1.403,1.18,1.954,2.058,1.858,1.658,1.245,1.229,2.016,2.045,1.674,1.916,1.703,2.103,2.09,1.719,1.496,1.425,1.341,1.612,1.287,1.545,1.399,1.241,1.506,1.864,1.961,1.267,1.7,1.325,1.99,2.09,1.741,1.619,1.309,1.287,1.232,2.035,1.916,2.099,1.522,2.141,2.103,1.741,1.751,1.329,2.074,1.851,1.19,1.777,2.106,1.558,1.861,1.89,2.077,2.058,1.503,1.193,1.9,1.616,1.816,1.174,1.89,1.851,1.683,1.938,1.941,1.261,1.322,1.258,1.845,1.993,1.441,1.512,1.474,1.793,1.338,1.874,1.732,1.183,1.641,1.525,2.08,2.083,1.987,1.448,1.596,1.467,1.97,2.019,1.322,1.322];

y = [1.351,1.212,1.219,1.264,1.27,1.387,1.512,1.5,1.487,1.451,1.529,1.525,1.835,2.016,1.838,1.574,1.616,1.416,1.57,1.754,1.735,1.693,1.6,1.629,1.354,1.335,1.351,1.629,1.848,1.745,1.587,1.741,1.925,1.858,1.59,1.548,1.906,1.958,1.958,1.725,1.358,1.467,1.758,1.635,1.674,1.48,1.496,1.667,1.661,1.693,1.861,1.609,1.538,1.5,1.37,1.638,1.79,1.745,1.758,1.858,1.945,1.99,1.835,1.67,1.725,1.516,1.358,1.287,1.2,1.438,1.89,1.867,1.732,1.835,1.774,1.725,1.796,1.622,1.603,1.451,1.68,1.822,1.661,1.512,1.864,2.058,1.983,1.793,1.687,1.383,1.39,1.764,1.909,1.822,1.777,1.609,1.638,1.603,1.603,1.38,1.38,1.29,1.39,1.629,1.67,1.696,1.69,1.519,1.635,1.619,1.458,1.725,1.877,1.877,1.903,1.848,1.812,1.477,1.351,1.312,1.387,1.577,1.664,1.629,1.57,1.687,1.593,1.554,1.577,1.887,1.79,1.58,1.596,1.667,1.719,1.67,1.525,1.635,1.309,1.354,1.59,1.635,1.732,1.716,1.545,1.403,1.622,1.658,1.377,1.425,1.803,1.864,1.577,1.59,1.89,1.738,1.593,1.764,1.832,1.758,1.503,1.712,1.896,1.903,1.683,1.529,1.761,1.664,1.661,1.683,1.635,1.654,1.587,1.574,1.429,1.729,1.87,1.793,1.783,1.561,1.79,1.77,1.487,1.461,1.38,1.403,1.377,1.287,1.383,1.619,1.777,1.619,1.664,1.577,1.506,1.68,1.519,1.28,1.432,1.709,1.548,1.416,1.309,1.464,1.667,1.712,1.558,1.741,1.7,1.68,1.464,1.377,1.612,1.793,1.787,1.664,1.464,1.441,1.641,1.77,1.774,1.574,1.732,1.9,1.767,1.593,1.79,1.622,1.777,1.732,1.58,1.735,1.529,1.567,1.661,1.803,1.638,1.503,1.461,1.68,1.522,1.387,1.532,1.774,1.912,1.635,1.441,1.406,1.503,1.754,1.616,1.683,1.69,1.683,1.409,1.477,1.606,1.725,1.629,1.851,1.774,1.561,1.483,1.335,1.535,1.622,1.641,1.787,1.496,1.558,1.735,1.583,1.583,1.467,1.322,1.403,1.541,1.854,1.983,1.964,1.616,1.419,1.561,1.548,1.493,1.425,1.748,1.958,1.906,1.68,1.603,1.841,1.925,1.748,1.729,1.567,1.47,1.683,1.751,1.635,1.409,1.441,1.835,1.945,1.829,1.6,1.338,1.458,1.838,1.9,1.799,1.825,1.838,2.022,1.974,1.735,1.545,1.435,1.435,1.47,1.406,1.461,1.377,1.345,1.548,1.799,1.735,1.512,1.545,1.558,1.89,1.945,1.767,1.577,1.377,1.296,1.454,1.838,1.941,1.906,1.79,2.029,1.99,1.812,1.654,1.612,1.88,1.69,1.48,1.774,1.87,1.732,1.829,1.919,2.025,1.906,1.535,1.467,1.7,1.693,1.616,1.48,1.758,1.783,1.777,1.893,1.751,1.412,1.325,1.422,1.761,1.787,1.561,1.509,1.564,1.609,1.551,1.741,1.593,1.416,1.545,1.674,1.961,2.025,1.858,1.6,1.558,1.622,1.883,1.803,1.803];

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
y_LS_2 = filter(numz_LS_2, denz_LS_2, u);

figure;
hold on;
plot(t, u)
plot(t, y, 'LineWidth', 3)
plot(t, y_LS_1, 'LineWidth', 3)
plot(t, y_LS_2, '--', 'LineWidth', 3)
legend('u', 'y', 'y_LS_1', 'y_LS_2')

%%
% N = 300;
% 
% Theta_RLS_1 = [0; 0; 0; 0; 0];
% P = eye(5)*100;
% 
% % u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)
% 
% for i=3:N
%   [Theta_RLS_1 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_1);
% end
% 
% numz_RLS_1 = [Theta_RLS_1(3) Theta_RLS_1(4) Theta_RLS_1(5)];
% denz_RLS_1 = [1 -Theta_RLS_1(1) -Theta_RLS_1(2)];
% 
% 
% Theta_RLS_2 = [0; 0; 0; 0; 0];
% P = eye(5)*1000;
% 
% % u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)
% 
% for i=3:N
%   [Theta_RLS_2 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_2);
% end
% 
% numz_RLS_2 = [Theta_RLS_2(3) Theta_RLS_2(4) Theta_RLS_2(5)];
% denz_RLS_2 = [1 -Theta_RLS_2(1) -Theta_RLS_2(2)];

%%
% 8) Comparar la respuesta de los modelos obtenidos en el punto anterior con la
% respuesta de la planta real utilizando la misma señal de entrada.
%%

% y_RLS_1 = filter(numz_RLS_1, denz_RLS_1, u);
% y_RLS_2 = filter(numz_RLS_2, denz_RLS_2, u);
% 
% figure;
% hold on;
% plot(t, u)
% plot(t, y, 'LineWidth', 3)
% plot(t, y_RLS_1, 'LineWidth', 3)
% plot(t, y_RLS_2, '--', 'LineWidth', 3)
% legend('u', 'y', 'y_LS_1', 'y_LS_2')
