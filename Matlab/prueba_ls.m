%% Control Digital en Sistemas Embebidos - MSE - PRACTICA 2

clc
clear all
close all
%%
% 1) Crear una función en Matlab que aplique la función de identificación por 
% método de cuadrados mínimos (LS) y obtenga el vector de parámetros del modelo 
% a partir del orden deseado del sistema y las señales de entrada/salida.
%%

R1 = 2e3;
C1 = 1e-6;
R2 = 1e3;
C2 = 1e-6;
%% 
% Opcion 1: Realizar el desarrollo matematico de la ecuación diferencial 
% del circuito y obtener la función transferencia en el dominio de Laplace
% Hs = 1 / ((R1*C1*R2*C2)*s^2 + (R1*C1+R1*C2+R2*C2)*s + 1)
s = tf('s');
Hs = 1 / ((R1*C1*R2*C2)*s^2 + (R1*C1+R1*C2+R2*C2)*s + 1)
[num den] = tfdata(Hs, 'v');


%%
% 3) Discretizar la planta con un período de muestreo h = 0.1s.
%%

h = 0.1;

Hz = c2d(Hs, h, 'zoh')

%%
% 4) Identificar los parámetros de la planta para orden 2 y 3 utilizando la 
% función LS creada anteriormente.
%%

t = 1:h:40;

[numz, denz] = tfdata(Hz, 'v');

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.383,1.383,1.516,2.041,1.932,1.148,1.696,1.609,1.648,1.796,1.419,1.367,1.741,1.18,2.064,1.558,1.722,1.577,1.17,1.354,1.519,1.319,1.235,1.783,2.112,1.283,1.783,2.07,1.209,2.0,1.183,1.506,1.425,1.98,1.445,1.59,1.767,1.283,1.2,1.845,1.935,1.716,2.054,1.587,1.235,1.458,1.664,1.977,1.351,1.416,1.519,1.6,1.248,1.558,1.425,1.725,1.406,1.964,1.577,2.09,1.732,1.306,1.574,1.416,1.399,1.154,1.329,1.622,1.151,1.645,2.048,2.122,1.467,1.883,1.532,1.632,1.37,1.658,1.274,1.938,1.777,1.954,1.567,2.041,2.006,1.687,1.906,1.974,1.867,1.167,1.912,1.838,1.27,1.358,1.903,1.661,2.077,1.264,1.454,1.612,1.177,1.219,1.203,2.116,1.777,1.832,1.37,1.28,1.28,1.906,1.538,1.77,1.7,2.025,1.864,1.258,1.651,2.029,1.158,1.658,1.758,1.935,1.941,2.106,1.97,1.329,1.996,1.174,1.974,1.338,1.69,1.887,1.225,1.906,1.258,1.387,1.57,2.041,1.867,1.709,1.419,1.67,1.909,2.087,1.516,1.17,1.512,1.829,2.045,1.7,1.306,1.951,1.812,1.28,1.712,1.451,1.567,1.351,1.777,1.487,1.448,1.187,1.89,1.651,2.048,1.77,2.093,2.132,1.903,1.338,1.148,1.648,1.541,1.948,2.035,1.932,1.229,1.735,1.841,1.58,2.006,1.461,1.606,2.083,1.867,1.961,1.854,1.896,1.474,2.038,1.183,1.919,1.383,1.416,1.345,1.916,1.438,1.487,2.025,2.032,1.341,1.925,1.335,1.283,1.258,1.687,2.074,1.245,1.493,1.506,1.383,1.245,1.706,2.148,1.606,1.787,2.019,2.148,1.767,1.6,1.429,1.609,1.361,1.661,1.522,1.777,1.306,2.012,1.567,1.88,2.051,1.493,1.809,1.148,1.835,1.916,1.799,1.812,1.909,1.299,1.264,1.532,2.019,1.796,1.209,1.861,1.838,1.487,1.193,1.78,1.554,1.5,1.98,1.345,1.735,1.654,1.438,1.616,1.587,1.935,1.409,2.064,1.59,2.129,1.922,1.483,2.054,2.022,1.309,1.748,1.429,2.025,1.929,1.229,1.374,1.183,1.809,2.016,2.032,1.525,1.377,1.896,1.954,2.093,1.348,1.77,2.058,1.987,2.109,1.206,2.067,1.716,1.816,1.967,2.038,1.641,1.58,2.003,1.261,1.635,1.193,2.148,1.441,1.719,1.148,1.445,1.858,1.793,1.754,1.906,1.654,1.748,1.229,1.758,1.832,1.338,1.98,1.48,1.883,1.925,1.57,1.235,2.022,2.058,1.938,1.774,1.277,1.964,1.277,1.425,1.322,1.206,1.561,1.341,1.538,1.712,1.196,1.361,1.29,1.996,1.18,1.725,1.258,1.696,1.674,2.051,1.616,1.245,2.103,1.358,1.506,1.245,1.512,1.77,1.554,1.361,1.732,1.903,1.822,1.403,1.609,1.906,1.209,2.138,1.68,1.977,1.606,1.354,1.912,1.677,1.829,1.819,2.106,1.235,2.022,1.793,1.238,1.98,1.448,1.177,1.235,1.274,1.222,1.932,2.145,2.122,1.18,1.338,2.061,1.2,1.2];

y = [ 1.851,1.467,1.396,1.493,1.941,1.929,1.290,1.619,1.609,1.638,1.764,1.480,1.387,1.670,1.270,1.916,1.622,1.703,1.596,1.245,1.332,1.483,1.345,1.254,1.687,2.032,1.419,1.716,2.003,1.354,1.874,1.309,1.467,1.432,1.877,1.522,1.577,1.729,1.364,1.229,1.732,1.896,1.748,1.996,1.658,1.309,1.429,1.622,1.909,1.451,1.419,1.500,1.577,1.306,1.509,1.438,1.667,1.454,1.867,1.632,2.006,1.780,1.390,1.538,1.435,1.403,1.196,1.303,1.558,1.225,1.567,1.961,2.090,1.580,1.825,1.583,1.619,1.412,1.609,1.335,1.825,1.787,1.919,1.632,1.964,1.996,1.741,1.874,1.954,1.880,1.296,1.800,1.829,1.370,1.358,1.800,1.687,2.003,1.396,1.441,1.577,1.248,1.222,1.206,1.948,1.806,1.825,1.451,1.306,1.287,1.790,1.583,1.735,1.703,1.967,1.880,1.370,1.596,1.948,1.300,1.590,1.725,1.896,1.932,2.074,1.987,1.448,1.890,1.306,1.851,1.432,1.638,1.841,1.335,1.800,1.354,1.380,1.535,1.951,1.880,1.738,1.474,1.635,1.858,2.045,1.609,1.248,1.461,1.761,1.993,1.751,1.387,1.848,1.816,1.377,1.648,1.487,1.548,1.387,1.703,1.522,1.458,1.235,1.767,1.670,1.977,1.809,2.041,2.116,1.938,1.445,1.203,1.564,1.545,1.874,2.003,1.941,1.358,1.664,1.806,1.619,1.932,1.545,1.593,1.993,1.890,1.948,1.870,1.890,1.548,1.945,1.322,1.806,1.458,1.419,1.358,1.809,1.506,1.487,1.925,2.009,1.464,1.838,1.425,1.306,1.264,1.609,1.987,1.377,1.467,1.496,1.403,1.270,1.625,2.051,1.683,1.767,1.970,2.112,1.829,1.638,1.464,1.580,1.399,1.612,1.538,1.729,1.383,1.896,1.625,1.832,2.009,1.587,1.764,1.261,1.729,1.880,1.812,1.809,1.890,1.403,1.287,1.487,1.919,1.816,1.319,1.761,1.822,1.545,1.254,1.680,1.577,1.509,1.893,1.445,1.680,1.658,1.477,1.587,1.587,1.867,1.493,1.958,1.658,2.041,1.941,1.567,1.964,2.009,1.438,1.687,1.474,1.922,1.925,1.354,1.367,1.216,1.699,1.958,2.016,1.612,1.419,1.809,1.929,2.061,1.477,1.716,1.996,1.987,2.087,1.367,1.935,1.754,1.803,1.938,2.019,1.709,1.603,1.929,1.380,1.583,1.264,1.983,1.538,1.683,1.245,1.406,1.774,1.787,1.761,1.877,1.693,1.735,1.319,1.677,1.803,1.422,1.877,1.551,1.819,1.903,1.629,1.306,1.890,2.029,1.954,1.803,1.374,1.854,1.380,1.412,1.335,1.229,1.496,1.367,1.506,1.670,1.280,1.341,1.300,1.867,1.303,1.645,1.325,1.625,1.664,1.977,1.680,1.325,1.958,1.464,1.493,1.290,1.470,1.712,1.580,1.399,1.670,1.861,1.825,1.477,1.583,1.845,1.325,1.987,1.738,1.929,1.664,1.409,1.819,1.703,1.806,1.816,2.051,1.383,1.903,1.812,1.341,1.861,1.522,1.238,1.232,1.264,1.229,1.803,2.080,2.109,1.348,1.338,1.925,1.925];

[Theta_LS_1] = identificacionLS(1, u, y);
numz_LS_1 = [Theta_LS_1(2) Theta_LS_1(3)];
denz_LS_1 = [1 -Theta_LS_1(1)];

[Theta_LS_2] = identificacionLS(2, u, y);
numz_LS_2 = [Theta_LS_2(3) Theta_LS_2(4) Theta_LS_2(5)];
denz_LS_2 = [1 -Theta_LS_2(1) -Theta_LS_2(2)];

%%
% 5)Obtener el error de ambas identificaciones utilizando la función de costo J.
%%

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
J_1 = (y-y_LS_1)'*(y-y_LS_1)/2;

y_LS_2 = filter(numz_LS_2, denz_LS_2, u);
J_2 = (y-y_LS_2)'*(y-y_LS_2)/2;

%%
% 6)Comparar la respuesta de los modelos obtenidos en el punto 4 con la 
% respuesta de la planta real utilizando la misma señal de entrada.
%%

%u = rand(length(t), 1);
%y = filter(numz, denz, u);

u = [ 1.383,1.383,1.516,2.041,1.932,1.148,1.696,1.609,1.648,1.796,1.419,1.367,1.741,1.18,2.064,1.558,1.722,1.577,1.17,1.354,1.519,1.319,1.235,1.783,2.112,1.283,1.783,2.07,1.209,2.0,1.183,1.506,1.425,1.98,1.445,1.59,1.767,1.283,1.2,1.845,1.935,1.716,2.054,1.587,1.235,1.458,1.664,1.977,1.351,1.416,1.519,1.6,1.248,1.558,1.425,1.725,1.406,1.964,1.577,2.09,1.732,1.306,1.574,1.416,1.399,1.154,1.329,1.622,1.151,1.645,2.048,2.122,1.467,1.883,1.532,1.632,1.37,1.658,1.274,1.938,1.777,1.954,1.567,2.041,2.006,1.687,1.906,1.974,1.867,1.167,1.912,1.838,1.27,1.358,1.903,1.661,2.077,1.264,1.454,1.612,1.177,1.219,1.203,2.116,1.777,1.832,1.37,1.28,1.28,1.906,1.538,1.77,1.7,2.025,1.864,1.258,1.651,2.029,1.158,1.658,1.758,1.935,1.941,2.106,1.97,1.329,1.996,1.174,1.974,1.338,1.69,1.887,1.225,1.906,1.258,1.387,1.57,2.041,1.867,1.709,1.419,1.67,1.909,2.087,1.516,1.17,1.512,1.829,2.045,1.7,1.306,1.951,1.812,1.28,1.712,1.451,1.567,1.351,1.777,1.487,1.448,1.187,1.89,1.651,2.048,1.77,2.093,2.132,1.903,1.338,1.148,1.648,1.541,1.948,2.035,1.932,1.229,1.735,1.841,1.58,2.006,1.461,1.606,2.083,1.867,1.961,1.854,1.896,1.474,2.038,1.183,1.919,1.383,1.416,1.345,1.916,1.438,1.487,2.025,2.032,1.341,1.925,1.335,1.283,1.258,1.687,2.074,1.245,1.493,1.506,1.383,1.245,1.706,2.148,1.606,1.787,2.019,2.148,1.767,1.6,1.429,1.609,1.361,1.661,1.522,1.777,1.306,2.012,1.567,1.88,2.051,1.493,1.809,1.148,1.835,1.916,1.799,1.812,1.909,1.299,1.264,1.532,2.019,1.796,1.209,1.861,1.838,1.487,1.193,1.78,1.554,1.5,1.98,1.345,1.735,1.654,1.438,1.616,1.587,1.935,1.409,2.064,1.59,2.129,1.922,1.483,2.054,2.022,1.309,1.748,1.429,2.025,1.929,1.229,1.374,1.183,1.809,2.016,2.032,1.525,1.377,1.896,1.954,2.093,1.348,1.77,2.058,1.987,2.109,1.206,2.067,1.716,1.816,1.967,2.038,1.641,1.58,2.003,1.261,1.635,1.193,2.148,1.441,1.719,1.148,1.445,1.858,1.793,1.754,1.906,1.654,1.748,1.229,1.758,1.832,1.338,1.98,1.48,1.883,1.925,1.57,1.235,2.022,2.058,1.938,1.774,1.277,1.964,1.277,1.425,1.322,1.206,1.561,1.341,1.538,1.712,1.196,1.361,1.29,1.996,1.18,1.725,1.258,1.696,1.674,2.051,1.616,1.245,2.103,1.358,1.506,1.245,1.512,1.77,1.554,1.361,1.732,1.903,1.822,1.403,1.609,1.906,1.209,2.138,1.68,1.977,1.606,1.354,1.912,1.677,1.829,1.819,2.106,1.235,2.022,1.793,1.238,1.98,1.448,1.177,1.235,1.274,1.222,1.932,2.145,2.122,1.18,1.338,2.061,1.2,1.2];

y = [ 1.851,1.467,1.396,1.493,1.941,1.929,1.290,1.619,1.609,1.638,1.764,1.480,1.387,1.670,1.270,1.916,1.622,1.703,1.596,1.245,1.332,1.483,1.345,1.254,1.687,2.032,1.419,1.716,2.003,1.354,1.874,1.309,1.467,1.432,1.877,1.522,1.577,1.729,1.364,1.229,1.732,1.896,1.748,1.996,1.658,1.309,1.429,1.622,1.909,1.451,1.419,1.500,1.577,1.306,1.509,1.438,1.667,1.454,1.867,1.632,2.006,1.780,1.390,1.538,1.435,1.403,1.196,1.303,1.558,1.225,1.567,1.961,2.090,1.580,1.825,1.583,1.619,1.412,1.609,1.335,1.825,1.787,1.919,1.632,1.964,1.996,1.741,1.874,1.954,1.880,1.296,1.800,1.829,1.370,1.358,1.800,1.687,2.003,1.396,1.441,1.577,1.248,1.222,1.206,1.948,1.806,1.825,1.451,1.306,1.287,1.790,1.583,1.735,1.703,1.967,1.880,1.370,1.596,1.948,1.300,1.590,1.725,1.896,1.932,2.074,1.987,1.448,1.890,1.306,1.851,1.432,1.638,1.841,1.335,1.800,1.354,1.380,1.535,1.951,1.880,1.738,1.474,1.635,1.858,2.045,1.609,1.248,1.461,1.761,1.993,1.751,1.387,1.848,1.816,1.377,1.648,1.487,1.548,1.387,1.703,1.522,1.458,1.235,1.767,1.670,1.977,1.809,2.041,2.116,1.938,1.445,1.203,1.564,1.545,1.874,2.003,1.941,1.358,1.664,1.806,1.619,1.932,1.545,1.593,1.993,1.890,1.948,1.870,1.890,1.548,1.945,1.322,1.806,1.458,1.419,1.358,1.809,1.506,1.487,1.925,2.009,1.464,1.838,1.425,1.306,1.264,1.609,1.987,1.377,1.467,1.496,1.403,1.270,1.625,2.051,1.683,1.767,1.970,2.112,1.829,1.638,1.464,1.580,1.399,1.612,1.538,1.729,1.383,1.896,1.625,1.832,2.009,1.587,1.764,1.261,1.729,1.880,1.812,1.809,1.890,1.403,1.287,1.487,1.919,1.816,1.319,1.761,1.822,1.545,1.254,1.680,1.577,1.509,1.893,1.445,1.680,1.658,1.477,1.587,1.587,1.867,1.493,1.958,1.658,2.041,1.941,1.567,1.964,2.009,1.438,1.687,1.474,1.922,1.925,1.354,1.367,1.216,1.699,1.958,2.016,1.612,1.419,1.809,1.929,2.061,1.477,1.716,1.996,1.987,2.087,1.367,1.935,1.754,1.803,1.938,2.019,1.709,1.603,1.929,1.380,1.583,1.264,1.983,1.538,1.683,1.245,1.406,1.774,1.787,1.761,1.877,1.693,1.735,1.319,1.677,1.803,1.422,1.877,1.551,1.819,1.903,1.629,1.306,1.890,2.029,1.954,1.803,1.374,1.854,1.380,1.412,1.335,1.229,1.496,1.367,1.506,1.670,1.280,1.341,1.300,1.867,1.303,1.645,1.325,1.625,1.664,1.977,1.680,1.325,1.958,1.464,1.493,1.290,1.470,1.712,1.580,1.399,1.670,1.861,1.825,1.477,1.583,1.845,1.325,1.987,1.738,1.929,1.664,1.409,1.819,1.703,1.806,1.816,2.051,1.383,1.903,1.812,1.341,1.861,1.522,1.238,1.232,1.264,1.229,1.803,2.080,2.109,1.348,1.338,1.925,1.925];

y_LS_1 = filter(numz_LS_1, denz_LS_1, u);
y_LS_2 = filter(numz_LS_2, denz_LS_2, u);

figure;
hold on;
plot(t, u)
plot(t, y, 'LineWidth', 3)
plot(t, y_LS_1, 'LineWidth', 3)
plot(t, y_LS_2, '--', 'LineWidth', 3)
legend('u', 'y', 'y_LS_1', 'y_LS_2')

%%
N = 300;

Theta_RLS_1 = [0; 0; 0; 0; 0];
P = eye(5)*100;

% u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)

for i=3:N
  [Theta_RLS_1 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_1);
end

numz_RLS_1 = [Theta_RLS_1(3) Theta_RLS_1(4) Theta_RLS_1(5)];
denz_RLS_1 = [1 -Theta_RLS_1(1) -Theta_RLS_1(2)];


Theta_RLS_2 = [0; 0; 0; 0; 0];
P = eye(5)*1000;

% u(k-2) u(k-1) u(k) y(k-2) y(k-1) y(k)

for i=3:N
  [Theta_RLS_2 P] = identificacionRLS(2, u(i-2:i), y(i-2:i), P, Theta_RLS_2);
end

numz_RLS_2 = [Theta_RLS_2(3) Theta_RLS_2(4) Theta_RLS_2(5)];
denz_RLS_2 = [1 -Theta_RLS_2(1) -Theta_RLS_2(2)];

%%
% 8) Comparar la respuesta de los modelos obtenidos en el punto anterior con la
% respuesta de la planta real utilizando la misma señal de entrada.
%%

y_RLS_1 = filter(numz_RLS_1, denz_RLS_1, u);
y_RLS_2 = filter(numz_RLS_2, denz_RLS_2, u);

figure;
hold on;
plot(t, u)
plot(t, y, 'LineWidth', 3)
plot(t, y_RLS_1, 'LineWidth', 3)
plot(t, y_RLS_2, '--', 'LineWidth', 3)
legend('u', 'y', 'y_RLS_1', 'y_RLS_2')
